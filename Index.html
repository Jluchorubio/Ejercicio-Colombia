<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Colombia: Departamentos y Turismo</title>
    <style>
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        .card img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; }
        .controls { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Explora Colombia</h1>

    <section>
        <h2>Departamentos (Grupo de 10)</h2>
        <div class="controls">
            <button onclick="changePage('dept', -1)">Anterior</button>
            <span id="page-dept">Página 1</span>
            <button onclick="changePage('dept', 1)">Siguiente</button>
        </div>
        <div id="container-dept" class="grid"></div>
    </section>

    <section>
        <h2>Sitios Turísticos (Grupo de 10)</h2>
        <div class="controls">
            <button onclick="changePage('tour', -1)">Anterior</button>
            <span id="page-tour">Página 1</span>
            <button onclick="changePage('tour', 1)">Siguiente</button>
        </div>
        <div id="container-tour" class="grid"></div>
    </section>

    <script>
        const API_URL = "https://api-colombia.com/api/v1";
        let deptPage = 1;
        let tourPage = 1;

        // Función para obtener los departamentos con detalles completos
        async function fetchDepartments(page) {
            const container = document.getElementById('container-dept');
            container.innerHTML = "Cargando departamentos..."; // Feedback visual de que estamos cargando.

            try {
                // 1. Obtenemos la lista paginada de departamentos
                const res = await fetch(`${API_URL}/Department/pagedList?page=${page}&pageSize=10`);
                if (!res.ok) throw new Error('No se pudo obtener la lista de departamentos');
                const result = await res.json();

                // 2. Obtenemos el detalle de cada uno para traer 'cityCapital' y 'region'
                const detailedDepts = await Promise.all(
                    result.data.map(async (dept) => {
                        const detailRes = await fetch(`${API_URL}/Department/${dept.id}`);
                        const detail = await detailRes.json();
                        // Obtener la región y la ciudad capital directamente
                        const regionRes = await fetch(`${API_URL}/Region/${detail.regionId}`);
                        const region = await regionRes.json();
                        const cityRes = await fetch(`${API_URL}/City/${detail.cityCapitalId}`);
                        const city = await cityRes.json();
                        return { ...detail, region, cityCapital: city };
                    })
                );

                container.innerHTML = ""; // Limpiamos el contenedor de "Cargando..."

                // 3. Añadimos los detalles de cada departamento al DOM
                detailedDepts.forEach(dept => {
                    container.innerHTML += `
                        <div class="card">
                            <h3>${dept.name}</h3>
                            <p><strong>Capital:</strong> ${dept.cityCapital ? dept.cityCapital.name : 'No disponible'}</p>
                            <p><strong>Región:</strong> ${dept.region ? dept.region.name : 'No disponible'}</p>
                            <p>${dept.description || 'Sin descripción disponible.'}</p>
                        </div>
                    `;
                });
            } catch (error) {
                // Si algo falla, mostramos un mensaje de error
                container.innerHTML = `<p>Hubo un error al cargar los departamentos: ${error.message}</p>`;
            }
        }

        // Función para obtener las atracciones turísticas con imágenes y ciudad
        async function fetchTouristicAttractions(page) {
            const container = document.getElementById('container-tour');
            container.innerHTML = "Cargando sitios..."; // Feedback visual de que estamos cargando.

            try {
                const res = await fetch(`${API_URL}/TouristicAttraction/pagedList?page=${page}&pageSize=20`);
                if (!res.ok) throw new Error('No se pudo obtener los sitios turísticos');
                const result = await res.json();

                // 1. Filtramos los sitios que tienen imágenes
                const conImagen = result.data.filter(p => p.images && p.images.length > 0).slice(0, 10);

                // 2. Obtenemos el detalle para traer el nombre de la ciudad
                const detailedPlaces = await Promise.all(
                    conImagen.map(async (place) => {
                        const detailRes = await fetch(`${API_URL}/TouristicAttraction/${place.id}`);
                        const detail = await detailRes.json();
                        const cityRes = await fetch(`${API_URL}/City/${detail.cityId}`);
                        const city = await cityRes.json();
                        return { ...detail, city };
                    })
                );

                container.innerHTML = ""; // Limpiamos el contenedor

                // 3. Añadimos los detalles de cada sitio turístico al DOM
                detailedPlaces.forEach(place => {
                    const cityName = place.city ? place.city.name : 'Ciudad no disponible'; // Si la ciudad no está disponible
                    const imageUrl = place.images[0] || 'https://via.placeholder.com/300x200?text=Imagen+no+disponible'; // Imagen por defecto

                    container.innerHTML += `
                        <div class="card">
                            <img src="${imageUrl}" alt="${place.name}" onerror="this.src='https://via.placeholder.com/300x200?text=Error+al+cargar'">
                            <h3>${place.name}</h3>
                            <p><strong>Ciudad:</strong> ${cityName}</p>
                            <p>${place.description || 'Sin descripción.'}</p>
                        </div>
                    `;
                });
            } catch (error) {
                // Si algo falla, mostramos un mensaje de error
                container.innerHTML = `<p>Hubo un error al cargar los sitios turísticos: ${error.message}</p>`;
            }
        }

        // Función para manejar la paginación
        function changePage(type, delta) {
            if (type === 'dept') {
                deptPage = Math.max(1, deptPage + delta);
                document.getElementById('page-dept').textContent = `Página ${deptPage}`;
                fetchDepartments(deptPage);
            } else {
                tourPage = Math.max(1, tourPage + delta);
                document.getElementById('page-tour').textContent = `Página ${tourPage}`;
                fetchTouristicAttractions(tourPage);
            }
        }

        // Carga inicial de los datos
        fetchDepartments(deptPage);
        fetchTouristicAttractions(tourPage);

    </script>
</body>
</html>

